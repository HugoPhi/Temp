# Tasks

KNNçš„å„é¡¹æ¢ç©¶å°†åœ¨CIFAR-10åˆ†ç±»æ•°æ®é›†ä¸Šè¿›è¡Œã€‚æ¢ç©¶å†…å®¹åŒ…æ‹¬ï¼š

- KNNçš„æ‰‹åŠ¨å®ç°ã€‚
- KNNçš„è·ç¦»è®¡ç®—æ–¹å¼ï¼ˆå¾ªç¯ï¼Œæ•´æ‰¹å¹¶è¡Œï¼Œæ‰¹æ¬¡å¹¶è¡Œï¼‰çš„è®¡ç®—æ•ˆç‡ã€‚
- åŸºäºä¸åŒè®¡ç®—æ¡†æ¶çš„KNNæ•ˆç‡ï¼ŒåŒ…æ‹¬ï¼šnumpy, torch-cpu, torch-gpu ã€‚
- KNNåœ¨K=5æŠ˜äº¤å‰éªŒè¯ä¸‹å‚æ•°kçš„é€‰æ‹©ã€‚
- æŸ¥çœ‹æŸä¸ªæµ‹è¯•æ ·ä¾‹çš„kä¸ªé‚»å±…æ˜¯ä»€ä¹ˆï¼Œæœ‰ä»€ä¹ˆå…±åŒç‰¹ç‚¹ï¼Œä»¥åŠä¸ºä»€ä¹ˆä¼šæŠŠä»–ä»¬å½’ä¸ºé‚»å±…ã€‚

## task1 

- ä»»åŠ¡ï¼šç»§æ‰¿Clfsæ¥å£ç±»ï¼Œå®ç°KNNClfï¼Œå¹¶ä¸sklearnçš„KNN(éœ€ç»§æ‰¿Clfsæ¥å£æ–¹ä¾¿æ‰§è¡Œ)è¿›è¡Œå¯¹æ¯”ã€‚ä¸ºäº†æ–¹ä¾¿ï¼Œå¯ä»¥ç­‰é‡å‡å°‘æ•°æ®ï¼Œæ¯”å¦‚æŠŠè®­ç»ƒé›†å’Œæµ‹è¯•é›†shuffleä¹‹åå‡å°‘10å€ã€‚
    - åŸºæœ¬å‚æ•°ï¼š
        - `k = 5`
        - `distance = 'manhattan'`
        - `algorithm = 'brute'`
    - æŒ‡æ ‡ï¼š
        - ä»£ç æµ‹è¯•æ—¶é—´ã€‚
        - å‡†ç¡®ç‡å’Œå¬å›ç‡ã€‚

æˆ‘ä»¬åœ¨å¦‚ä¸‹ç¯å¢ƒï¼š

> cpu: i7-13700H @ 2.40GHz  
> ram: 32G  

çš„torch_pf_cpuç»“æœå¦‚ä¸‹ï¼š

![task1 result](./assets/task1.png)

è¿™é‡Œæˆ‘ä»¬æ˜¯åœ¨æ•°æ®é›†`train: 5000, test: 1000`çš„æƒ…å†µä¸‹åšçš„ï¼Œä¸”éƒ½å…ˆè¿›è¡Œäº†shuffleï¼Œå†è¿›è¡Œçš„åˆ†å‰² ã€‚  
å¯ä»¥çœ‹åˆ°è‡ªå·±å®ç°çš„å’Œå®˜æ–¹åº“çš„å·®è·ï¼Œå³ä½¿æˆ‘ä»¬ä½¿ç”¨torch-cpuçš„æ¡†æ¶ä¹Ÿè¿›è¡Œäº†å¤šçº¿ç¨‹æ•´æ‰¹æ¬¡ä¼˜åŒ–ï¼Œä½†æ˜¯ä¾ç„¶æ— æ³•è¾¾åˆ°å’Œæ ‡å‡†åº“ä¸€æ ·çš„æ•ˆæœï¼ŒåŸå› æœ‰å¾…è€ƒå¯Ÿã€‚

å€¼å¾—å¥‡æ€ªçš„æ˜¯ï¼Œæˆ‘å°†å®éªŒå¹³å°è½¬æ¢åˆ°ï¼š

> cpu: 12 vCPU Intel(R) Xeon(R) Platinum 8352V CPU @ 2.10GHz  
> ram: 90G  
> gpu: vGPU-32GB(32GB) * 1  

ä¹‹åï¼Œè¿è¡Œç›¸åŒçš„ä»£ç ï¼Œå¾—åˆ°çš„ç»“æœå´æ˜¯å¦‚ä¸‹(å¤šæ¬¡å®éªŒ)ï¼š

![task2_on_autodl](./assets/task1_on_autodl.png)

å¯ä»¥çœ‹åˆ°æ— è®ºcpuè¿˜æ˜¯gpuéƒ½æ¯”sklearnçš„ç®—æ³•åº“æœ‰æ›´é«˜çš„æ€§èƒ½ï¼ŒçœŸæ˜¯ä»¤äººæ‘¸ä¸ç€å¤´è„‘ğŸ¤”ã€‚  


## task2

- ä»»åŠ¡ï¼š
    - å¯¹äºknnçš„è·ç¦»è®¡ç®—ï¼Œå®ç°æ‰¹æ¬¡å¾ªç¯è®¡ç®—ã€‚
    - åŒæ—¶åŸºäºä¸¤ç§æ¡†æ¶å¯¹æ•°æ®çš„è®¡ç®—è¿›è¡Œå®ç°ï¼šnumpyå’Œpytorch ã€‚
    - è¿›è¡Œä»¥ä¸‹çš„å®éªŒï¼ˆ`k=5`, `algorithm='brute'`ï¼Œ`distance = 'manhattan'`ï¼‰ï¼š
        ```txt
        |     name     |  BS(test, train)  |  backend  | device |
        | sklearn      |       None        | sklearn   |   cpu  |
        | bb_numpy     | (256   , 1024   ) | numpy     |   cpu  |
        | fb_numpy     | (n_test, 64     ) | numpy     |   cpu  |
        | bf_numpy     | (16    , n_train) | numpy     |   cpu  |
        | pf_numpy     | (n_test, 1      ) | numpy     |   cpu  |
        | fp_numpy     | (1     , n_train) | numpy     |   cpu  |
        | ff_numpy     | (1     , 1      ) | numpy     |   cpu  |
        | bb_torch_cpu | (256   , 1024   ) | torch_cpu |   cpu  |
        | fb_torch_cpu | (n_test, 64     ) | torch_cpu |   cpu  |
        | bf_torch_cpu | (16    , n_train) | torch_cpu |   cpu  |
        | pf_torch_cpu | (n_test, 1      ) | torch_cpu |   cpu  |
        | fp_torch_cpu | (1     , n_train) | torch_cpu |   cpu  |
        | ff_torch_cpu | (1     , 1      ) | torch_cpu |   cpu  |
        | bb_torch     | (256   , 1024   ) | torch     |   gpu  |
        | fb_torch     | (n_test, 64     ) | torch     |   gpu  |
        | bf_torch     | (16    , n_train) | torch     |   gpu  |
        | pf_torch     | (n_test, 1      ) | torch     |   gpu  |
        | fp_torch     | (1     , n_train) | torch     |   gpu  |
        | ff_torch     | (1     , 1      ) | torch     |   gpu  |
        ```

        > å®éªŒå‰é¢å‚æ•°çš„æ„æ€ï¼š
        > - `f: for loop`
        > - `b: batch parallel`
        > - `p: parallel`

    - ä¸ºäº†å‡å°‘å‹åŠ›ï¼Œè¿˜æ˜¯é‡‡ç”¨shuffleä¹‹åç­‰æ¯”ä¾‹å‡å°‘æ•°æ®é›†çš„æ–¹å¼å¯¹æ•°æ®é›†è¿›è¡Œç¼©å‡ã€‚ 

è¿™é‡Œæˆ‘ä»¬åˆ°æœåŠ¡å™¨è¿›è¡Œå®éªŒï¼Œé…ç½®å’Œtask1çš„ä¸€æ ·ï¼š 

> cpu: 12 vCPU Intel(R) Xeon(R) Platinum 8352V CPU @ 2.10GHz  
> ram: 90G  
> gpu: vGPU-32GB(32GB) * 1  

æœ€åå¾—åˆ°çš„ç»“æœå¦‚ä¸‹ï¼š 

![task2](./assets/task2.png)

é€”ä¸­çš„è“è‰²è¡¨ç¤ºå¯¹ç…§ç»„ï¼Œçº¢è‰²è¡¨ç¤ºæ•ˆæœæœ€å·®çš„ç»„åˆï¼Œç»¿è‰²è¡¨ç¤ºæ•ˆæœæœ€å¥½çš„ç»„åˆã€‚
å¯ä»¥æ³¨æ„åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š  

- åœ¨è¿™ä¸ªç¡¬ä»¶é…ç½®ä¸‹ï¼Œè¶…è¿‡sklearnçš„å¤šçº¿ç¨‹çš„æœ‰ï¼š
    - `pf_torch_cpu`
    - all gpu with batch or parallel
- æ™®éæ¥çœ‹ï¼Œåœ¨ç›¸åŒçš„ç¡¬ä»¶é…ç½®ä¸‹ï¼Œ`pf`å…·æœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œä¸ºä»€ä¹ˆæˆ‘ä¹Ÿæ²¡æƒ³æ˜ç™½ï¼Œä½ ä»¬è‡ªå·±æƒ³å§ã€‚æºç ä¸­æåˆ°äº†è¿™ä¸ªï¼š
    ```python
    # `strategy="parallel_on_X"` has in practice be shown
    # to be more efficient than `strategy="parallel_on_Y``
    # on many combination of datasets.
    # Hence, we choose to enforce it here.
    # For more information, see:
    # https://github.com/scikit-learn/scikit-learn/pull/24076#issuecomment-1445258342  # noqa
    # TODO: adapt the heuristic for `strategy="auto"` for
    # `ArgKminClassMode` and use `strategy="auto"`.
    ```

- `pf`å¯¹äºé€Ÿåº¦çš„æå‡åœ¨å¤šçº¿ç¨‹CPUçš„æƒ…å†µä¸‹æ›´åŠ æ˜æ˜¾ä¸€äº›ï¼Œå¦‚æœä»æ¯”ä¾‹çš„è§’åº¦æ¥çœ‹ã€‚
- é€šè¿‡è§‚å¯Ÿï¼Œå¯ä»¥åˆæ­¥ç¡®å®šnumpyåŸºæœ¬åœ¨å•æ ¸è¿è¡Œï¼›torch-cpuå’Œsklearnæ˜¯å¤šçº¿ç¨‹è¿è¡Œã€‚  

## task3

- ä»»åŠ¡ï¼š
    - ä½¿ç”¨K=5æŠ˜äº¤å‰éªŒè¯æ¥é€‰æ‹©åˆé€‚çš„å‚æ•°kï¼Œå¹¶ç”»å‡ºä¸åŒçš„kçš„ç»“æœæ›²çº¿å›¾ã€‚ 
    - è¿™é‡Œéœ€è¦ä½¿ç”¨å®Œå…¨çš„æ•°æ®é›†ï¼Œå°±æ˜¯æ•´ä¸ªCIFAR-10ã€‚

è¿™ä¸ªä»»åŠ¡æˆ‘ä»¬çš„å‚æ•°æ˜¯ï¼š

```python
k_range = [1, ..., 19] + [20, 40, ..., 200]
batch_size = (1000, 1)
distance = 'manhattan'
backend = 'torch'  # on GPU
```

æ•´ä¸ªè¿‡ç¨‹å¤§æ¦‚è€—æ—¶50minã€‚æœ€åçš„ç»“æœå¦‚ä¸‹ï¼š 




## task4

- ä»»åŠ¡ï¼š
    - è§‚å¯Ÿæµ‹è¯•é›†çš„æŸä¸ªæ ·æœ¬å’Œå®ƒçš„kä¸ªé‚»å±…çš„å…±åŒç‰¹ç‚¹ï¼Œä»¥åŠä¸ºä»€ä¹ˆä¼šæŠŠä»–ä»¬å½’ä¸ºé‚»å±…ã€‚
    - å‚æ•°ï¼š`k=5`ï¼Œ`distance='manhattan'`ã€‚
    - ä½¿ç”¨å®Œå…¨çš„æ•°æ®é›†ã€‚


## Some Questions ? 

### # Q1

åœ¨åštask3çš„æ—¶å€™ï¼Œç”¨torch-gpué…ç½®ï¼Œåœ¨`batch_size=(10000, 1)`å’Œ`batch_size=(128, 1024)`ä¸‹ï¼Œè§‚å¯Ÿæ˜¾å­˜çš„å˜åŒ–ï¼Œå‘ç°å‰è€…çš„æ˜¾å­˜ä¼šåœ¨kå¢åŠ 6ä¹‹åå¢åŠ 5Gï¼Œè€Œåè€…ä¼šåœ¨kå¢åŠ 2ä¹‹åå¢åŠ 2Gï¼Œä¸­é—´ä¿æŒå¹³æ»‘ã€‚

è¿™é‡Œå±•ç¤ºå‰è€…åœ¨`k=1,2,3,4,5,6,7`è¿‡ç¨‹çš„å˜åŒ–ï¼š 

![q1](./assets/q1.png)

åè€…ç±»ä¼¼ï¼Œåªæ˜¯å˜åŒ–å‘¨æœŸå’Œå¹…åº¦ä¸åŒã€‚

åé¢æˆ‘åˆåšäº†ä¸€ä¸‹`batch_size=(1000, 1)`çš„ï¼Œå‘ç°è¿™ä¸ªé€’å¢ç°è±¡æ›´åŠ é¢‘ç¹ï¼Œä½†æ˜¯å¹…åº¦æ›´å°ï¼Œè€Œä¸”æ¯”`(1000, 1)`æ›´å¿«ï¼Œä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆã€‚`k=1 ~ 12`çš„ç»“æœå¦‚ä¸‹ï¼š 

![q1_2](./assets/q1_2.png)

è€Œä¸”å¥‡æ€ªçš„æ˜¯kåœ¨ä»20åˆ°200ï¼Œæ­¥é•¿20çš„è¿‡ç¨‹ä¸­ï¼Œå˜åŒ–å¹…åº¦å’Œkåœ¨å‰é¢çš„æ—¶å€™æ˜¯ä¸€æ ·çš„ï¼Œè¯´æ˜ä¸å¤ªå¯èƒ½æ˜¯kçš„é—®é¢˜ã€‚å¦‚ä¸‹å›¾ï¼š 

![q_3](./assets/q1_3.png)

çœŸæ˜¯TMçš„å¥‡æ€ªã€‚æˆ‘æ“ã€‚

### # Q2

åœ¨åštask1çš„æ—¶å€™ï¼Œå‡ºç°çš„é‚£ä¸ªå› ä¸ºè¿è¡Œå¹³å°ä¸åŒè€Œå¯¼è‡´è‡ªå·±æ‰‹åŠ¨å®ç°çš„KNNæ•ˆæœå’Œsklearn KNNçš„ç»“æœå¯¹æ¯”å‡ºç°æ”»å®ˆæ˜“å½¢çš„æƒ…å†µã€‚å¯ä»¥è¿”å›å»å†çœ‹ä¸€étask1 ã€‚  

### # Q3 

åœ¨åštask2çš„æ—¶å€™ï¼Œä¸ºä»€ä¹ˆ`pf`å…·æœ‰æ›´å¥½çš„æ€§èƒ½ï¼Ÿ 

### # Q4

åœ¨task4çš„æ—¶å€™ï¼Œä¸‹é¢è¿™ä¸ªæƒ…å†µçš„åˆ¤æ–­é”™è¯¯å¦‚ä½•é¿å…ï¼Ÿ

![q4](./assets/q4.png)

é€šè¿‡ç¬¬ä¸€ä¸ªé‚»å±…å·²ç»å¯ä»¥ä»»åŠ¡å’Œæ ·ä¾‹ååˆ†ç›¸è¿‘ï¼Œèƒ½ä¸èƒ½é€šè¿‡è®¾è®¡ä¸€ä¸ªå’Œç›¸ä¼¼åº¦ç›¸å…³çš„æƒé‡è®¡ç®—æ–¹æ³•ï¼ŒæŠŠæ¯ä¸€ä¸ªç±»åˆ«çš„å¦æ®ç»Ÿè®¡æ•°ç›®çš„é€‚åˆä¹˜ä¸Šè¿™ä¸ªæƒé‡ã€‚

## Other Expriments You Can Do.

### # 1

å‰é¢è¯´äº†`pf`çš„æ•ˆæœæœ€å¥½ï¼Œå¯ä»¥å›ºå®škï¼Œå°è¯•æ”¹æˆä¸åŒçš„`pb`æˆ–è€…`bf`ï¼Œå°±æ˜¯æŠŠç¬¬äºŒä¸ªbä»å°å–åˆ°å¤§ï¼Œè§‚å¯Ÿæµ‹è¯•æ—¶é—´çš„å˜åŒ–ã€‚è¿™ä¸ªå®éªŒå¯ä»¥åœ¨åštask3ä¹‹å‰åšä¸€ä¸‹ï¼Œç”¨æ¥ç¡®å®šåˆé€‚çš„`pb`æˆ–è€…`bf`ã€‚  

> A: 
> è¿™å¯èƒ½å’Œæ•°æ®é›†å’Œæµ‹è¯•é›†çš„æ€§èƒ½éƒ½æœ‰å…³ï¼Œç”±äºè¿™é‡Œæµ‹è¯•æœ‰é™ï¼Œå› æ­¤ä¸èƒ½ä»£è¡¨æ™®éæƒ…å†µï¼Œå¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ª[issue](https://github.com/scikit-learn/scikit-learn/pull/24076#issuecomment-1226609185).
